---
# deploy-container.yml
- name: Deploy Java Application Docker Container
  hosts: app_servers
  become: no  # Changed to no to avoid sudo requirement
  vars:
    image_repo: "{{ image_repo }}"
    image_name: "{{ image_name }}"
    app_port: "{{ app_port }}"
    container_port: "{{ container_port }}"
    
  tasks:
    - name: Stop and remove containers using the same port
      shell: |
        # Find and stop containers using the same port
        for container_id in $(docker ps -q --filter "publish={{ app_port }}"); do
          docker stop $container_id
          docker rm $container_id
        done
      ignore_errors: yes
      
    - name: Run Docker container
      command: >
        docker run -d 
        --name {{ image_repo | basename }}-{{ image_name }} 
        -p {{ app_port }}:{{ container_port }} 
        --restart always 
        {{ image_repo }}:{{ image_name }}
      
    - name: Show deployment information
      debug:
        msg: 
          - "Application deployed successfully"
          - "Container ID: {{ image_repo | basename }}-{{ image_name }}"
          - "Access URL: http://localhost:{{ app_port }}"
